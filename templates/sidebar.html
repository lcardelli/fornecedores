<link rel="stylesheet" href="/static/css/sidebar.css">

<nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
    <div class="sidebar-sticky">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link {{ if eq .activeMenu "dashboard" }}active{{ end }}" href="/api/v1/dashboard">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
            </li>

            <!-- Menu Fornecedores -->
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#fornecedoresSubmenu" data-toggle="collapse" aria-expanded="false">
                    <i class="fas fa-building"></i>
                    Fornecedores
                </a>
                <ul class="collapse nav flex-column ml-3" id="fornecedoresSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "catalogo" }}active{{ end }}" href="/api/v1/catalogo">
                            <i class="fas fa-book"></i>
                            Catálogo
                        </a>
                    </li>
                  
                    {{ if .user.Admin }}
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "cadastro-categoria" }}active{{ end }}" href="/api/v1/cadastro-categoria">
                            <i class="fas fa-folder-plus"></i>
                            Gerenciar Áreas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "services" }}active{{ end }}" href="/api/v1/services">
                            <i class="fas fa-cogs"></i>
                            Gerenciar Categorias
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "cadastro-produto" }}active{{ end }}" href="/api/v1/produtos">
                            <i class="fas fa-box"></i>
                            Gerenciar Produtos
                        </a>
                    </li>
                    {{ end }}
                </ul>
            </li>

            <!-- Menu Licenças -->
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#licencasSubmenu" data-toggle="collapse" aria-expanded="false">
                    <i class="fas fa-key"></i>
                    Licenças
                </a>
                <ul class="collapse nav flex-column ml-3" id="licencasSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "visualizar-licencas" }}active{{ end }}" href="/api/v1/licenses/view">
                            <i class="fas fa-list"></i>
                            Visualizar Licenças
                        </a>
                    </li>
                    {{ if .user.Admin }}
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "gerenciar-licencas" }}active{{ end }}" href="/api/v1/licenses/manage">
                            <i class="fas fa-cog"></i>
                            Gerenciar Licenças
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "softwares" }}active{{ end }}" href="/api/v1/licenses/software">
                            <i class="fas fa-laptop-code"></i>
                            Gerenciar Softwares
                        </a>
                    </li>
                    {{ end }}
                </ul>
            </li>

            {{ if .user.Admin }}
            <!-- Menu Administração -->
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#adminSubmenu" data-toggle="collapse" aria-expanded="false">
                    <i class="fas fa-user-shield"></i>
                    Administração
                </a>
                <ul class="collapse nav flex-column ml-3" id="adminSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "manage-users" }}active{{ end }}" href="/api/v1/manage-users">
                            <i class="fas fa-users-cog"></i>
                            <span>Gerenciar Usuários</span>
                        </a>
                    </li>
                </ul>
            </li>
            {{ end }}
        </ul>
    </div>
</nav>

<script>
$(document).ready(function() {
    // Função para verificar e abrir o submenu ativo
    function checkActiveSubmenu() {
        const activeLink = $('.nav-link.active');
        if (activeLink.length) {
            // Encontra o submenu pai do link ativo
            const parentSubmenu = activeLink.closest('.collapse.nav');
            if (parentSubmenu.length) {
                // Abre o submenu pai
                parentSubmenu.addClass('show');
                parentSubmenu.prev('.dropdown-toggle').attr('aria-expanded', 'true');
                
                // Salva o estado no localStorage
                const menuId = parentSubmenu.attr('id');
                localStorage.setItem('menu-#' + menuId, 'open');
            }
        }
    }

    // Função para verificar qual menu deve estar aberto baseado na URL atual
    function checkCurrentPath() {
        const currentPath = window.location.pathname;
        
        // Mapeamento de caminhos para seus respectivos submenus
        const menuMappings = {
            '/api/v1/catalogo': '#fornecedoresSubmenu',
            '/api/v1/lista-fornecedores': '#fornecedoresSubmenu',
            '/api/v1/cadastro-categoria': '#fornecedoresSubmenu',
            '/api/v1/services': '#fornecedoresSubmenu',
            '/api/v1/produtos': '#fornecedoresSubmenu',
            
            '/api/v1/licenses/active': '#licencasSubmenu',
            '/api/v1/licenses/expired': '#licencasSubmenu',
            '/api/v1/licenses/manage': '#licencasSubmenu',
            '/api/v1/licenses/software': '#licencasSubmenu',
            
            '/api/v1/manage-users': '#adminSubmenu'
        };

        const targetSubmenu = menuMappings[currentPath];
        if (targetSubmenu) {
            $(targetSubmenu).addClass('show');
            $(`a[href="${targetSubmenu}"]`).attr('aria-expanded', 'true');
            localStorage.setItem('menu-' + targetSubmenu, 'open');
        }
    }

    // Executa ao carregar a página
    checkActiveSubmenu();
    checkCurrentPath();

    // Handler para cliques nos toggles do dropdown
    $('.dropdown-toggle').click(function(e) {
        e.preventDefault();
        const target = $(this).attr('href');
        const submenu = $(target);
        
        // Toggle do submenu atual
        if (submenu.hasClass('show')) {
            submenu.removeClass('show');
            $(this).attr('aria-expanded', 'false');
            localStorage.removeItem('menu-' + target);
        } else {
            submenu.addClass('show');
            $(this).attr('aria-expanded', 'true');
            localStorage.setItem('menu-' + target, 'open');
        }
    });

    // Restaura o estado dos menus do localStorage
    $('.dropdown-toggle').each(function() {
        const menuId = $(this).attr('href');
        const savedState = localStorage.getItem('menu-' + menuId);
        
        if (savedState === 'open') {
            $(this).attr('aria-expanded', 'true');
            $(menuId).addClass('show');
        }
    });

    // Previne o fechamento do submenu quando clica em links dentro dele
    $('.collapse.nav .nav-link').click(function(e) {
        e.stopPropagation(); // Impede a propagação do evento
        const parentSubmenu = $(this).closest('.collapse.nav');
        const menuId = '#' + parentSubmenu.attr('id');
        localStorage.setItem('menu-' + menuId, 'open');
    });
});
</script>
