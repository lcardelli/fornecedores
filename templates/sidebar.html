<nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
    <div class="sidebar-sticky pt-3">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link {{ if eq .activeMenu "dashboard" }}active{{ end }}" href="/api/v1/dashboard" target="_blank">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
            </li>

            <!-- Menu Fornecedores -->
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#fornecedoresSubmenu" data-toggle="collapse" aria-expanded="false">
                    <i class="fas fa-building"></i>
                    Fornecedores
                </a>
                <ul class="collapse nav flex-column ml-3" id="fornecedoresSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "catalogo" }}active{{ end }}" href="/api/v1/catalogo" target="_blank">
                            <i class="fas fa-book"></i>
                            Catálogo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "lista-fornecedores" }}active{{ end }}" href="/api/v1/lista-fornecedores" target="_blank">
                            <i class="fas fa-list"></i>
                            Lista de Fornecedores
                        </a>
                    </li>
                    {{ if .user.Admin }}
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "cadastro-categoria" }}active{{ end }}" href="/api/v1/cadastro-categoria" target="_blank">
                            <i class="fas fa-folder-plus"></i>
                            Gerenciar Áreas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "services" }}active{{ end }}" href="/api/v1/services" target="_blank">
                            <i class="fas fa-cogs"></i>
                            Gerenciar Categorias
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "cadastro-produto" }}active{{ end }}" href="/api/v1/produtos" target="_blank">
                            <i class="fas fa-box"></i>
                            Gerenciar Produtos
                        </a>
                    </li>
                    {{ end }}
                </ul>
            </li>

            <!-- Menu Licenças -->
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#licencasSubmenu" data-toggle="collapse" aria-expanded="false">
                    <i class="fas fa-key"></i>
                    Licenças
                </a>
                <ul class="collapse nav flex-column ml-3" id="licencasSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "licencas-ativas" }}active{{ end }}" href="/api/v1/licenses/active" target="_blank">
                            <i class="fas fa-check-circle"></i>
                            Licenças Ativas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "licencas-vencidas" }}active{{ end }}" href="/api/v1/licenses/expired" target="_blank">
                            <i class="fas fa-exclamation-circle"></i>
                            Licenças Vencidas
                        </a>
                    </li>
                    {{ if .user.Admin }}
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "gerenciar-licencas" }}active{{ end }}" href="/api/v1/licenses/manage" target="_blank">
                            <i class="fas fa-cog"></i>
                            Gerenciar Licenças
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "softwares" }}active{{ end }}" href="/api/v1/licenses/software" target="_blank">
                            <i class="fas fa-laptop-code"></i>
                            Gerenciar Softwares
                        </a>
                    </li>
                    {{ end }}
                </ul>
            </li>

            {{ if .user.Admin }}
            <!-- Menu Administração -->
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#adminSubmenu" data-toggle="collapse" aria-expanded="false">
                    <i class="fas fa-user-shield"></i>
                    Administração
                </a>
                <ul class="collapse nav flex-column ml-3" id="adminSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {{ if eq .activeMenu "manage-users" }}active{{ end }}" href="/api/v1/manage-users" target="_blank">
                            <i class="fas fa-users-cog"></i>
                            Gerenciar Usuários
                        </a>
                    </li>
                </ul>
            </li>
            {{ end }}
        </ul>
    </div>
</nav>

<style>
.nav-link {
    padding: 0.5rem 1rem;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.nav-link:hover {
    color: #007bff;
    text-decoration: none;
}

.nav-link.active {
    color: #007bff;
    font-weight: bold;
}

.nav-link i:first-child {
    margin-right: 8px;
    width: 20px;
    text-align: center;
}

/* Ajustes para o dropdown */
.dropdown-toggle::after {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.dropdown-toggle[aria-expanded="true"]::after {
    transform: rotate(180deg);
}

/* Ajustes para o submenu */
.collapse.nav {
    background-color: #f8f9fa;
    padding-left: 2.5rem;
    position: static !important;
    height: 0;
    overflow: hidden;
    transition: height 0.3s ease;
    display: block !important;
    margin: 0 !important;
}

.collapse.nav.show {
    height: auto;
}

/* Ajuste para o container do submenu */
.nav-item {
    position: relative;
}

/* Remove margem padrão do collapse */
.collapse {
    margin: 0 !important;
}

/* Ajuste para os ícones nos subitens */
.collapse.nav .nav-link i {
    font-size: 0.9em;
}

/* Ajuste para o espaçamento dos itens do submenu */
.collapse.nav .nav-item {
    width: 100%;
}

.collapse.nav .nav-link {
    padding-left: 0;
    font-size: 0.95em;
}

/* Ajuste para o dropdown toggle */
.nav-link.dropdown-toggle {
    cursor: pointer;
}

/* Remove a transição padrão do collapse do Bootstrap */
.collapsing {
    transition: none !important;
}
</style>

<script>
$(document).ready(function() {
    // Função para verificar e abrir o submenu ativo
    function checkActiveSubmenu() {
        const activeLink = $('.nav-link.active');
        if (activeLink.length) {
            // Encontra o submenu pai do link ativo
            const parentSubmenu = activeLink.closest('.collapse.nav');
            if (parentSubmenu.length) {
                // Abre o submenu pai
                parentSubmenu.addClass('show');
                parentSubmenu.prev('.dropdown-toggle').attr('aria-expanded', 'true');
                
                // Salva o estado no localStorage
                const menuId = parentSubmenu.attr('id');
                localStorage.setItem('menu-#' + menuId, 'open');
            }
        }
    }

    // Função para verificar qual menu deve estar aberto baseado na URL atual
    function checkCurrentPath() {
        const currentPath = window.location.pathname;
        
        // Mapeamento de caminhos para seus respectivos submenus
        const menuMappings = {
            '/api/v1/catalogo': '#fornecedoresSubmenu',
            '/api/v1/lista-fornecedores': '#fornecedoresSubmenu',
            '/api/v1/cadastro-categoria': '#fornecedoresSubmenu',
            '/api/v1/services': '#fornecedoresSubmenu',
            '/api/v1/produtos': '#fornecedoresSubmenu',
            
            '/api/v1/licenses/active': '#licencasSubmenu',
            '/api/v1/licenses/expired': '#licencasSubmenu',
            '/api/v1/licenses/manage': '#licencasSubmenu',
            '/api/v1/licenses/software': '#licencasSubmenu',
            
            '/api/v1/manage-users': '#adminSubmenu'
        };

        const targetSubmenu = menuMappings[currentPath];
        if (targetSubmenu) {
            $(targetSubmenu).addClass('show');
            $(`a[href="${targetSubmenu}"]`).attr('aria-expanded', 'true');
            localStorage.setItem('menu-' + targetSubmenu, 'open');
        }
    }

    // Executa ao carregar a página
    checkActiveSubmenu();
    checkCurrentPath();

    // Handler para cliques nos toggles do dropdown
    $('.dropdown-toggle').click(function(e) {
        e.preventDefault();
        const target = $(this).attr('href');
        const submenu = $(target);
        
        // Toggle do submenu atual
        if (submenu.hasClass('show')) {
            submenu.removeClass('show');
            $(this).attr('aria-expanded', 'false');
            localStorage.removeItem('menu-' + target);
        } else {
            submenu.addClass('show');
            $(this).attr('aria-expanded', 'true');
            localStorage.setItem('menu-' + target, 'open');
        }
    });

    // Restaura o estado dos menus do localStorage
    $('.dropdown-toggle').each(function() {
        const menuId = $(this).attr('href');
        const savedState = localStorage.getItem('menu-' + menuId);
        
        if (savedState === 'open') {
            $(this).attr('aria-expanded', 'true');
            $(menuId).addClass('show');
        }
    });

    // Previne o fechamento do submenu quando clica em links dentro dele
    $('.collapse.nav .nav-link').click(function(e) {
        e.stopPropagation(); // Impede a propagação do evento
        const parentSubmenu = $(this).closest('.collapse.nav');
        const menuId = '#' + parentSubmenu.attr('id');
        localStorage.setItem('menu-' + menuId, 'open');
    });
});
</script>
